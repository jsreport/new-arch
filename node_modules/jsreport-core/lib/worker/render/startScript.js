const promisify = require('util').promisify

module.exports = function (reporter, inputs, callback, done) {
  const callbackAsync = promisify(callback)

  reporter.initForRequest(callbackAsync)

  return reporter.render(inputs.req).then(r => {
    const sharedBuf = new SharedArrayBuffer(r.content.byteLength)
    const buf = Buffer.from(sharedBuf)
    r.content.copy(buf)

    done(null, {
      meta: r.meta,
      content: buf
    })
  }).catch(e => done(e))
}
