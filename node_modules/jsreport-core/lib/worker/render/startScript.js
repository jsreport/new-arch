const promisify = require('util').promisify

module.exports = async function (reporter, inputs, logger, callback) {
  const { registry, req } = inputs

  const requestId = req.context.requestId

  registry.set(requestId, {
    callback,
    logger: logger
  })

  try {
    const res = await reporter.render(req)

    const sharedBuf = new SharedArrayBuffer(res.content.byteLength)
    const buf = Buffer.from(sharedBuf)

    res.content.copy(buf)

    return {
      meta: res.meta,
      content: buf
    }
  } finally {
    registry.delete(requestId)
  }
}
