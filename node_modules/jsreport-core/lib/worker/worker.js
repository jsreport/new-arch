const promisify = require('util').promisify
const ReporterWorker = require('./reporterWorker')
let reporter

module.exports = (inputs, callback, done) => {    
    if (inputs.action === 'init') {
        reporter = new ReporterWorker(inputs)
        return reporter.init()
            .then(() => done())
            .catch((e) => done(e))      
    }

    if (inputs.action === 'render') {
        const callbackAsync = promisify(callback)
        reporter.initForRequest(callbackAsync)
        return reporter.render(inputs.req)
            .then(r => {
                const sharedBuf = new SharedArrayBuffer(r.content.byteLength)
                const buf = Buffer.from(sharedBuf)
                r.content.copy(buf)
                done(null, {
                    meta: r.meta,               
                    content: buf
                })
            })
            .catch(e => done(e))
    }

    done(new Error(`Unsupported worker action ${inputs.action}`))    
}